
> quntedge@0.3 test:payment
> vitest --config vitest.payment.config.ts --run lib/__tests__/payment-flows.test.ts


 RUN  v2.1.9 /Users/timon/Downloads/lassttry-edge--main

stdout | lib/__tests__/payment-flows.test.ts
[2026-02-01T22:29:31.587Z] WARN: [SecurityManager] Encryption key not configured 

stderr | lib/__tests__/payment-flows.test.ts
DATABASE_URL not configured. Using IN-MEMORY MOCK.

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Payment Service Tests > Checkout Session Creation > should create a checkout session for monthly plan
[2026-02-01T22:29:31.632Z] INFO: [PaymentService] Checkout session created {"userId":"test-user-1","email":"test@example.com","plan":"monthly"}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Payment Service Tests > Checkout Session Creation > should create a checkout session with referral code
[2026-02-01T22:29:31.636Z] INFO: [PaymentService] Checkout session created {"userId":"test-user-2","email":"test@example.com","plan":"yearly"}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Payment Service Tests > Transaction Recording > should record a successful transaction
[PrismaMock] Checking unique whopTransactionId: txn_test_123 in 0 records
[2026-02-01T22:29:31.651Z] INFO: [PaymentService] Transaction recorded {"transactionId":"1qeq0f","userId":"test-user","amount":2900}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Payment Service Tests > Transaction Recording > should not record duplicate transactions
[PrismaMock] Checking unique whopTransactionId: txn_test_123 in 0 records
[2026-02-01T22:29:31.653Z] INFO: [PaymentService] Transaction recorded {"transactionId":"s3rct9","userId":"test-user","amount":2900}
[PrismaMock] Checking unique whopTransactionId: txn_test_123 in 1 records
[PrismaMock] Duplicate found!
[2026-02-01T22:29:31.653Z] ERROR: [PaymentService] Failed to record transaction {"error":{"code":"P2002"},"data":{"userId":"test-user","email":"test@example.com","whopTransactionId":"txn_test_123","amount":2900,"currency":"USD","type":"SUBSCRIPTION","status":"COMPLETED"}}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Payment Service Tests > Invoice Creation > should create an invoice
[2026-02-01T22:29:31.655Z] INFO: [PaymentService] Invoice created {"invoiceId":"8uxa4","userId":"test-user","amountDue":2900}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Payment Service Tests > Refund Processing > should process a full refund
[PrismaMock] Checking unique whopTransactionId: txn_test_refund in 0 records
[2026-02-01T22:29:31.657Z] INFO: [PaymentService] Refund initiated {"refundId":"rpc3j","transactionId":"ptwj3","amount":2900}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Payment Service Tests > Refund Processing > should process a partial refund
[PrismaMock] Checking unique whopTransactionId: txn_test_partial in 0 records
[2026-02-01T22:29:31.658Z] INFO: [PaymentService] Refund initiated {"refundId":"lz4dxj","transactionId":"3wc4po","amount":1450}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Payment Service Tests > Refund Processing > should fail to refund non-completed transaction
[PrismaMock] Checking unique whopTransactionId: txn_test_pending in 0 records

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Subscription Creation > should create a monthly subscription
[2026-02-01T22:29:31.666Z] INFO: [SubscriptionManager] Subscription created/updated {"subscriptionId":"ogv26x","userId":"test-user-monthly","plan":"monthly","status":"ACTIVE"}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Subscription Creation > should create a trial subscription
[2026-02-01T22:29:31.667Z] INFO: [SubscriptionManager] Subscription created/updated {"subscriptionId":"sas8re","userId":"test-user-trial","plan":"monthly","status":"TRIAL"}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Subscription Creation > should create a lifetime subscription
[2026-02-01T22:29:31.668Z] INFO: [SubscriptionManager] Subscription created/updated {"subscriptionId":"fdk1uc","userId":"test-user-lifetime","plan":"lifetime","status":"ACTIVE"}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Subscription Updates > should upgrade subscription plan
[2026-02-01T22:29:31.669Z] INFO: [SubscriptionManager] Subscription updated {"userId":"test-user-upgrade","updateData":{"plan":"YEARLY","interval":"year"}}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Subscription Updates > should downgrade subscription plan
[2026-02-01T22:29:31.670Z] INFO: [SubscriptionManager] Subscription updated {"userId":"test-user-downgrade","updateData":{"plan":"MONTHLY","interval":"month"}}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Subscription Cancellation > should cancel subscription immediately
[2026-02-01T22:29:31.673Z] INFO: [SubscriptionManager] Subscription cancelled immediately {"userId":"test-user-cancel-immediate"}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Subscription Cancellation > should schedule subscription cancellation
[2026-02-01T22:29:31.674Z] INFO: [SubscriptionManager] Subscription scheduled for cancellation {"userId":"test-user-cancel-end","effectiveDate":"2026-03-03T22:29:31.674Z"}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Payment Failure Handling > should mark subscription as past due on first failure
[2026-02-01T22:29:31.675Z] INFO: [SubscriptionManager] Payment failure recorded, subscription past due {"userId":"test-user-fail-1","attemptNumber":1}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Payment Failure Handling > should cancel subscription after 3 failures
[2026-02-01T22:29:31.676Z] WARN: [SubscriptionManager] Subscription cancelled due to payment failure {"userId":"test-user-fail-3","attempts":3}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Payment Success Handling > should update subscription on successful payment
[PrismaMock] Checking unique whopTransactionId: pay_1769984971678 in 0 records
[2026-02-01T22:29:31.678Z] INFO: [PaymentService] Transaction recorded {"transactionId":"n9l05s","userId":"test-user-success","amount":2900}
[2026-02-01T22:29:31.678Z] INFO: [SubscriptionManager] Payment success handled {"userId":"test-user-success","amount":2900,"endDate":"2026-04-02T22:29:31.677Z"}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Subscription Manager Tests > Grace Period Management > should start grace period for expired subscriptions
[2026-02-01T22:29:31.681Z] INFO: [SubscriptionManager] Grace period started {"subscriptionId":"auz939","gracePeriodEndsAt":"2026-02-07T22:29:31.681Z"}
[2026-02-01T22:29:31.682Z] INFO: [SubscriptionManager] Grace period check completed {"processed":1,"errors":0}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Webhook Service Tests > Membership Events > should process membership.activated event
[2026-02-01T22:29:31.688Z] INFO: [WebhookService] Processing webhook event {"eventType":"membership.activated","eventId":"evt_test_activated"}
[2026-02-01T22:29:31.691Z] INFO: [SubscriptionManager] Subscription created/updated {"subscriptionId":"0ryqg8","userId":"user_webhook","plan":"monthly","status":"ACTIVE"}
[2026-02-01T22:29:31.691Z] INFO: [WebhookService] Membership activated {"email":"webhook@example.com","plan":"monthly","interval":"month","isTrial":false}
[2026-02-01T22:29:31.691Z] INFO: [WebhookService] Webhook event logged {"eventId":"evt_test_activated","eventType":"membership.activated","success":true,"processed":true}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Webhook Service Tests > Membership Events > should process membership.deactivated event
[2026-02-01T22:29:31.693Z] INFO: [WebhookService] Processing webhook event {"eventType":"membership.deactivated","eventId":"evt_test_deactivated"}
[2026-02-01T22:29:31.695Z] INFO: [WebhookService] Membership deactivated {"email":"webhook@example.com"}
[2026-02-01T22:29:31.695Z] INFO: [WebhookService] Webhook event logged {"eventId":"evt_test_deactivated","eventType":"membership.deactivated","success":true,"processed":true}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Webhook Service Tests > Membership Events > should process membership.updated event
[2026-02-01T22:29:31.696Z] INFO: [WebhookService] Processing webhook event {"eventType":"membership.updated","eventId":"evt_test_updated"}
[2026-02-01T22:29:31.697Z] INFO: [WebhookService] Membership updated {"email":"webhook@example.com","plan":"yearly"}
[2026-02-01T22:29:31.697Z] INFO: [WebhookService] Webhook event logged {"eventId":"evt_test_updated","eventType":"membership.updated","success":true,"processed":true}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Webhook Service Tests > Payment Events > should process payment.failed event
[2026-02-01T22:29:31.724Z] INFO: [WebhookService] Processing webhook event {"eventType":"payment.failed","eventId":"evt_test_payment_failed"}
[2026-02-01T22:29:31.724Z] INFO: [WebhookService] Payment failed {"email":"test@example.com","attemptNumber":1}
[2026-02-01T22:29:31.724Z] INFO: [WebhookService] Webhook event logged {"eventId":"evt_test_payment_failed","eventType":"payment.failed","success":true,"processed":true}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Webhook Service Tests > Invoice Events > should process invoice.created event
[2026-02-01T22:29:31.725Z] INFO: [WebhookService] Processing webhook event {"eventType":"invoice.created","eventId":"evt_test_invoice_created"}
[2026-02-01T22:29:31.725Z] INFO: [PaymentService] Invoice created {"invoiceId":"nivx9d","userId":"user_invoice","amountDue":2900}
[2026-02-01T22:29:31.725Z] INFO: [WebhookService] Invoice created {"invoiceId":"inv_test_webhook","email":"invoice@example.com"}
[2026-02-01T22:29:31.726Z] INFO: [WebhookService] Webhook event logged {"eventId":"evt_test_invoice_created","eventType":"invoice.created","success":true,"processed":true}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Webhook Service Tests > Invoice Events > should process invoice.paid event
[2026-02-01T22:29:31.726Z] INFO: [WebhookService] Processing webhook event {"eventType":"invoice.paid","eventId":"evt_test_invoice_paid"}
[2026-02-01T22:29:31.726Z] INFO: [WebhookService] Invoice paid {"invoiceId":"inv_test_paid"}
[2026-02-01T22:29:31.726Z] INFO: [WebhookService] Webhook event logged {"eventId":"evt_test_invoice_paid","eventType":"invoice.paid","success":true,"processed":true}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Security Manager Tests > Encryption/Decryption > should encrypt and decrypt text correctly
[2026-02-01T22:29:31.733Z] ERROR: [SecurityManager] Encryption failed {"error":"Encryption key not configured"}

stderr | lib/__tests__/payment-flows.test.ts > Payment System Tests > Security Manager Tests > Encryption/Decryption > should encrypt and decrypt text correctly
[SecurityManager] Encryption error details: Error: Encryption key not configured
    at SecurityManager.encrypt (/Users/timon/Downloads/lassttry-edge--main/server/payment-security.ts:53:15)
    at /Users/timon/Downloads/lassttry-edge--main/lib/__tests__/payment-flows.test.ts:631:43
    at file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:146:14
    at file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:533:11
    at runWithTimeout (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:39:7)
    at runTest (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:1056:17)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at runSuite (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:1205:15)

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > Security Manager Tests > Encryption/Decryption > should produce different encrypted values for same input
[2026-02-01T22:29:31.740Z] ERROR: [SecurityManager] Encryption failed {"error":"Encryption key not configured"}

stderr | lib/__tests__/payment-flows.test.ts > Payment System Tests > Security Manager Tests > Encryption/Decryption > should produce different encrypted values for same input
[SecurityManager] Encryption error details: Error: Encryption key not configured
    at SecurityManager.encrypt (/Users/timon/Downloads/lassttry-edge--main/server/payment-security.ts:53:15)
    at /Users/timon/Downloads/lassttry-edge--main/lib/__tests__/payment-flows.test.ts:639:44
    at file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:146:14
    at file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:533:11
    at runWithTimeout (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:39:7)
    at runTest (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:1056:17)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at runSuite (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/timon/Downloads/lassttry-edge--main/node_modules/@vitest/runner/dist/index.js:1205:15)

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > End-to-End Payment Flow Tests > should complete full subscription lifecycle
[2026-02-01T22:29:31.758Z] INFO: [PaymentService] Checkout session created {"userId":"e2e-test-user","email":"e2e@example.com","plan":"monthly"}
[2026-02-01T22:29:31.758Z] INFO: [SubscriptionManager] Subscription created/updated {"subscriptionId":"cfdh7","userId":"e2e-test-user","plan":"monthly","status":"ACTIVE"}
[PrismaMock] Checking unique whopTransactionId: txn_e2e in 0 records
[2026-02-01T22:29:31.759Z] INFO: [PaymentService] Transaction recorded {"transactionId":"w6ud49","userId":"e2e-test-user","amount":2900}
[2026-02-01T22:29:31.759Z] INFO: [SubscriptionManager] Subscription cancelled immediately {"userId":"e2e-test-user"}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > End-to-End Payment Flow Tests > should handle payment failure and retry
[2026-02-01T22:29:31.759Z] INFO: [SubscriptionManager] Subscription created/updated {"subscriptionId":"b8b6rc","userId":"e2e-retry-user","plan":"monthly","status":"ACTIVE"}
[2026-02-01T22:29:31.760Z] INFO: [SubscriptionManager] Payment failure recorded, subscription past due {"userId":"e2e-retry-user","attemptNumber":1}
[2026-02-01T22:29:31.760Z] INFO: [SubscriptionManager] Payment failure recorded, subscription past due {"userId":"e2e-retry-user","attemptNumber":2}
[2026-02-01T22:29:31.760Z] WARN: [SubscriptionManager] Subscription cancelled due to payment failure {"userId":"e2e-retry-user","attempts":3}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > End-to-End Payment Flow Tests > should handle plan upgrade
[2026-02-01T22:29:31.762Z] INFO: [SubscriptionManager] Subscription created/updated {"subscriptionId":"pn7arp","userId":"e2e-upgrade-user","plan":"monthly","status":"ACTIVE"}
[2026-02-01T22:29:31.762Z] INFO: [SubscriptionManager] Subscription updated {"userId":"e2e-upgrade-user","updateData":{"plan":"YEARLY","interval":"year"}}

stdout | lib/__tests__/payment-flows.test.ts > Payment System Tests > End-to-End Payment Flow Tests > should handle refund flow
[PrismaMock] Checking unique whopTransactionId: txn_e2e_refund in 0 records
[2026-02-01T22:29:31.763Z] INFO: [PaymentService] Refund initiated {"refundId":"1t7pc5","transactionId":"n9r44c","amount":2900}

 ❯ lib/__tests__/payment-flows.test.ts (46 tests | 3 failed) 137ms
   × Payment System Tests > Webhook Service Tests > Payment Events > should process payment.succeeded event 26ms
     → Cannot read properties of undefined (reading 'memberships')
   × Payment System Tests > Security Manager Tests > Encryption/Decryption > should encrypt and decrypt text correctly 12ms
     → Encryption failed
   × Payment System Tests > Security Manager Tests > Encryption/Decryption > should produce different encrypted values for same input 7ms
     → Encryption failed

⎯⎯⎯⎯⎯⎯⎯ Failed Tests 3 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  lib/__tests__/payment-flows.test.ts > Payment System Tests > Webhook Service Tests > Payment Events > should process payment.succeeded event
TypeError: Cannot read properties of undefined (reading 'memberships')
 ❯ lib/__tests__/payment-flows.test.ts:543:43
    541| 
    542|         // Spy on whop.memberships.retrieve instead of non-existent fe…
    543|         const retrieveSpy = vi.spyOn(whop.memberships, 'retrieve').moc…
       |                                           ^
    544|           id: 'membership_test',
    545|           valid: true,

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/3]⎯

 FAIL  lib/__tests__/payment-flows.test.ts > Payment System Tests > Security Manager Tests > Encryption/Decryption > should encrypt and decrypt text correctly
Error: Encryption failed
 ❯ SecurityManager.encrypt server/payment-security.ts:75:13
     73|       logger.error('[SecurityManager] Encryption failed', { error: err…
     74|       console.error('[SecurityManager] Encryption error details:', err…
     75|       throw new Error('Encryption failed')
       |             ^
     76|     }
     77|   }
 ❯ lib/__tests__/payment-flows.test.ts:631:43

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/3]⎯

 FAIL  lib/__tests__/payment-flows.test.ts > Payment System Tests > Security Manager Tests > Encryption/Decryption > should produce different encrypted values for same input
Error: Encryption failed
 ❯ SecurityManager.encrypt server/payment-security.ts:75:13
     73|       logger.error('[SecurityManager] Encryption failed', { error: err…
     74|       console.error('[SecurityManager] Encryption error details:', err…
     75|       throw new Error('Encryption failed')
       |             ^
     76|     }
     77|   }
 ❯ lib/__tests__/payment-flows.test.ts:639:44

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/3]⎯

 Test Files  1 failed (1)
      Tests  3 failed | 43 passed (46)
   Start at  03:59:27
   Duration  3.81s (transform 456ms, setup 473ms, collect 541ms, tests 137ms, environment 0ms, prepare 298ms)

