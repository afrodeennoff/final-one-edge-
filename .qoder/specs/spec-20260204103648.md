# Qunt Edge Production Setup Plan

## Overview
Comprehensive audit and configuration of the Qunt Edge trading analytics platform to make it production-ready. This includes setting up all external services (Supabase auth, Google OAuth, Whop payments), configuring API callbacks, and verifying integrations.

---

## Current State Analysis

### Already Configured
- Supabase project URL and keys (in `.env`)
- Database connection strings (transaction pooler + direct)
- Application URLs pointing to `qunt-edge.vercel.app`
- Basic security secrets (ENCRYPTION_KEY, CRON_SECRET)

### Missing/Empty Credentials
- Whop payment credentials (all fields empty)
- Google OAuth (needs Supabase configuration)
- Discord OAuth (not visible in .env, configure in Supabase)
- OpenAI API key
- Resend email API key
- Tradovate broker credentials
- Rithmic API URL

---

## Implementation Steps

### Phase 1: Supabase Authentication Configuration

#### 1.1 Configure Google OAuth in Supabase

**Supabase Dashboard Steps:**
1. Go to https://supabase.com/dashboard
2. Select your project (rtfknzopyeigfwbbnwxf)
3. Navigate to **Authentication > Providers**
4. Enable **Google** provider

**Google Cloud Console Setup:**
1. Go to https://console.cloud.google.com
2. Create new project or select existing
3. Navigate to **APIs & Services > Credentials**
4. Click **Create Credentials > OAuth client ID**
5. Configure OAuth consent screen:
   - App name: "Qunt Edge"
   - User support email: Your email
   - Authorized domains: `qunt-edge.vercel.app` (and custom domain if applicable)
6. Create OAuth 2.0 Client ID:
   - Application type: **Web application**
   - Name: "Qunt Edge Production"
   - Authorized JavaScript origins:
     ```
     https://qunt-edge.vercel.app
     https://rtfknzopyeigfwbbnwxf.supabase.co
     ```
   - Authorized redirect URIs:
     ```
     https://rtfknzopyeigfwbbnwxf.supabase.co/auth/v1/callback
     ```
7. Copy Client ID and Client Secret
8. In Supabase, paste credentials and set:
   - Authorized Client IDs: Your client ID
   - Save configuration

#### 1.2 Configure Discord OAuth in Supabase

**Discord Developer Portal:**
1. Go to https://discord.com/developers/applications
2. Create new application: "Qunt Edge"
3. Go to **OAuth2 > General**
4. Add redirect:
   ```
   https://rtfknzopyeigfwbbnwxf.supabase.co/auth/v1/callback
   ```
5. Copy Client ID and Client Secret
6. In Supabase **Authentication > Providers > Discord**, enable and paste credentials

#### 1.3 Configure Supabase Auth Settings

In Supabase Dashboard **Authentication > URL Configuration**:
- Site URL: `https://qunt-edge.vercel.app`
- Redirect URLs (add all):
  ```
  https://qunt-edge.vercel.app/**
  https://qunt-edge.vercel.app/api/auth/callback
  https://qunt-edge.vercel.app/dashboard
  ```

---

### Phase 2: Whop Payment Integration

#### 2.1 Whop Dashboard Setup

1. Log in to https://dash.whop.com
2. Go to **Settings > Developer**
3. Copy your API credentials:
   - **API Key** → `WHOP_API_KEY`
   - **Client Secret** → `WHOP_CLIENT_SECRET`
   - **Company ID** → `WHOP_COMPANY_ID`

#### 2.2 Create Subscription Plans in Whop

Create these plans in Whop dashboard:
| Plan | Price | Interval | Env Variable |
|------|-------|----------|--------------|
| Monthly | $19.99/mo | Monthly | `NEXT_PUBLIC_WHOP_MONTHLY_PLAN_ID` |
| Quarterly | $45/3mo | 3 months | `NEXT_PUBLIC_WHOP_6MONTH_PLAN_ID` |
| Yearly | $120/yr | Yearly | `NEXT_PUBLIC_WHOP_YEARLY_PLAN_ID` |
| Lifetime | $300 | One-time | `NEXT_PUBLIC_WHOP_LIFETIME_PLAN_ID` |

Copy each Plan ID from Whop dashboard.

#### 2.3 Configure Whop Webhook

1. In Whop Dashboard, go to **Webhooks**
2. Create webhook with URL:
   ```
   https://qunt-edge.vercel.app/api/whop/webhook
   ```
3. Select all relevant events:
   - `membership.activated`
   - `membership.deactivated`
   - `membership.updated`
   - `membership.trialing`
   - `payment.succeeded`
   - `payment.failed`
   - `payment.refunded`
   - `payment.partially_refunded`
   - `invoice.created`
   - `invoice.paid`
   - `invoice.payment_failed`
4. Copy webhook secret → `WHOP_WEBHOOK_SECRET`

---

### Phase 3: Environment Variables Update

Update `.env` file with all credentials:

```bash
# WHOP PAYMENTS
WHOP_API_KEY=your_whop_api_key
WHOP_CLIENT_SECRET=your_whop_client_secret
WHOP_WEBHOOK_SECRET=your_webhook_secret
WHOP_COMPANY_ID=your_company_id

NEXT_PUBLIC_WHOP_APP_ID=your_app_id
NEXT_PUBLIC_WHOP_PRODUCT_URL=https://whop.com/your-store/

NEXT_PUBLIC_WHOP_MONTHLY_PLAN_ID=plan_xxxxx
NEXT_PUBLIC_WHOP_6MONTH_PLAN_ID=plan_xxxxx
NEXT_PUBLIC_WHOP_YEARLY_PLAN_ID=plan_xxxxx
NEXT_PUBLIC_WHOP_LIFETIME_PLAN_ID=plan_xxxxx

# AI FEATURES
OPENAI_API_KEY=sk-xxxx

# EMAIL SERVICE
RESEND_API_KEY=re_xxxx
```

---

### Phase 4: Database Schema Deployment

```bash
# Generate Prisma client
npx prisma generate

# Push schema to database (if not done)
npx prisma db push

# Or run migrations
npx prisma migrate deploy
```

---

### Phase 5: Domain Configuration

#### Option A: Vercel Domain (qunt-edge.vercel.app)
Already configured in `.env`. No changes needed.

#### Option B: Custom Domain
1. Add custom domain in Vercel project settings
2. Update all URLs in `.env`:
   ```bash
   NEXT_PUBLIC_APP_URL="https://yourdomain.com"
   NEXT_PUBLIC_BASE_URL="https://yourdomain.com"
   NEXT_PUBLIC_SITE_URL="https://yourdomain.com"
   REDIRECT_URL="https://yourdomain.com/api/auth/callback"
   ```
3. Update Supabase Auth redirect URLs
4. Update Google OAuth authorized origins/redirects
5. Update Discord OAuth redirect
6. Update Whop webhook URL

---

### Phase 6: Code Review & Fixes

#### Files to Review
| File | Purpose | Status |
|------|---------|--------|
| `/app/api/auth/callback/route.ts` | OAuth callback handler | OK |
| `/server/auth.ts` | Auth functions (Google, Discord) | OK |
| `/app/api/whop/webhook/route.ts` | Payment webhook handler | OK |
| `/lib/whop.ts` | Whop SDK initialization | OK |
| `/server/payment-service.ts` | Payment processing | OK |

#### Potential Issues to Address
1. **Whop fallback key**: In `/lib/whop.ts`, there's a dummy key for build time. This is acceptable but should have real key in production.

2. **Admin user IDs**: Currently empty in `.env`:
   ```bash
   ADMIN_USER_ID=
   ALLOWED_ADMIN_USER_ID=
   ```
   Set these after first user signs up.

---

### Phase 7: Verification Checklist

#### Authentication Testing
- [ ] Sign in with Google OAuth
- [ ] Sign in with Discord OAuth
- [ ] Sign in with email/password
- [ ] Password reset flow
- [ ] User record created in database

#### Payment Testing
- [ ] View pricing plans page
- [ ] Create checkout session
- [ ] Complete test payment (use Whop test mode)
- [ ] Webhook receives payment confirmation
- [ ] Subscription status updates in database

#### API Endpoints Testing
```bash
# Health check
curl https://qunt-edge.vercel.app/api/health/db

# Auth callback (manual OAuth flow)
# Test by initiating login and checking redirect
```

---

## Files to Modify

| File | Action |
|------|--------|
| `.env` | Add missing credentials |
| Supabase Dashboard | Configure OAuth providers |
| Whop Dashboard | Create plans, webhook |
| Google Cloud Console | Create OAuth credentials |
| Discord Developer Portal | Create OAuth app |

---

## Verification Steps

1. **Build Test**
   ```bash
   npm run build
   ```

2. **Type Check**
   ```bash
   npm run typecheck
   ```

3. **Local Development**
   ```bash
   npm run dev
   ```

4. **Test OAuth Flow**
   - Visit `/authentication`
   - Click "Sign in with Google"
   - Verify redirect and callback

5. **Test Payment Flow**
   - Visit `/pricing` or billing page
   - Click upgrade button
   - Verify Whop checkout loads

---

## Summary

This plan covers:
1. Google OAuth setup in Supabase + Google Cloud
2. Discord OAuth setup in Supabase + Discord Portal
3. Whop payment integration with webhook
4. Environment variable configuration
5. Database schema verification
6. Testing procedures for both domains

No code changes are required - the application code is properly implemented. The work involves external service configuration and credential setup.
